---
keyword: [NAT网关, 共享带宽, 访问公网]
---

# 多应用共享公网带宽（控制台）

本文为您介绍如何组合使用NAT网关和共享带宽，实现多个应用共享一份公网带宽，以节省公网成本。

## 配置场景

本文以下图场景为例。某公司创建了两台ECS实例，每台ECS实例都部署了一个应用服务，要求应用服务可以面向互联网提供服务，服务端口为80。两个ECS实例在不同时间段的带宽需求量不同，具体如下：

-   ECS1实例的业务高峰期为每天的13:00:00~18:00:00，带宽需求量为700 Mbps，其他时间为业务低谷期，带宽需求量为300 Mbps。
-   ECS2实例的业务高峰期为每天的19:00:00~23:00:00，带宽需求量为700 Mbps，其他时间为业务低谷期，带宽需求量为300 Mbps。

如果为每个ECS实例购买公网带宽，则需要购买1000 Mbps带宽，但在业务低谷期带宽利用率低，造成带宽资源浪费。

您可以组合使用NAT网关的DNAT功能和共享带宽的共享功能，配置成功后：

-   DNAT功能可以将NAT网关上的公网IP映射给ECS实例使用，使ECS实例可以面向互联网提供服务。
-   共享带宽可以实现多个应用共享一份公网带宽，以节省公网成本。

![配置场景](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9267021061/p170562.png)

## 前提条件

-   您已经创建了专有网络VPC（Virtual Private Cloud）和交换机。具体操作，请参见[使用专有网络](/cn.zh-CN/专有网络和交换机/使用专有网络.md)。
-   您已经在交换机中创建了ECS实例，且ECS实例部署了应用服务。具体操作，请参见[使用向导创建实例](/cn.zh-CN/实例/创建实例/使用向导创建实例.md)。
-   您已经创建了两个弹性公网IP（Elastic IP Address，简称EIP），用于绑定NAT网关实例。EIP必须满足以下条件：

    -   EIP的地域与要绑定的NAT网关的地域相同。
    -   EIP的计费方式必须为按量付费。
    具体操作，请参见[申请新EIP](/cn.zh-CN/用户指南/申请EIP/申请新EIP.md)。


## 配置步骤

![配置步骤](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6875121061/p170824.png)

## 步骤一：创建NAT网关

NAT网关是一款企业级的公网网关，提供NAT代理功能。在配置DNAT条目前，您需要先创建一个NAT网关实例。

完成以下操作，创建NAT网关。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在**NAT网关**页面，单击**创建NAT网关**。

3.  在**创建NAT网关**面板，根据以下信息配置NAT网关，然后单击**立即购买**并完成支付。

    -   **付费模式**：选择NAT网关实例的付费模式。

        -   **包年包月**：包年包月是一种先付费后使用的付费模式。更多信息，请参见[包年包月](/cn.zh-CN/购买指南/包年包月.md)。
        -   **按量付费**：按量付费是一种先使用后付费的付费模式。更多信息，请参见[按量付费](/cn.zh-CN/购买指南/按量付费.md)。
        本示例选择**包年包月**。

    -   **地域和可用区**：选择需要创建NAT网关的地域。
    -   **可用区**：选择NAT网关实例所属的可用区。
    -   **VPC ID**：选择NAT网关所属的VPC。创建NAT网关后，不能修改NAT网关所属的VPC。

        **说明：** 如果在VPC列表中，找不到目标VPC，请从以下方面进行排查：

        -   查看该VPC是否已经配置NAT网关。一个VPC只能配置一个普通型NAT网关。
        -   查看该VPC中是否存在目标网段为0.0.0.0/0的自定义路由。如果存在，请删除该路由条目。
        -   RAM账号不具备读取访问VPC的权限，请联系主账号进行授权。
    -   **交换机ID**：选择NAT网关实例所属的交换机。

        **说明：** 仅创建增强型NAT网关时才支持选择NAT网关实例所属的交换机。

    -   **网关类型**：选择要创建的NAT网关类型，默认选择为**增强型**。
    -   **名称**：设置NAT网关实例的名称。

        名称长度为2~128个字符，以英文字母或中文开头，可包含数字、下划线（\_）和短划线（-）。

    -   **规格**：选择NAT网关的规格。

        -   **小型**
        -   **中型**
        -   **大型**
        NAT网关的规格会影响SNAT功能的最大连接数和每秒新建连接数，但不会影响DNAT性能。更多信息，请参见[增强型NAT网关（新推出）](/cn.zh-CN/增强型NAT网关/增强型NAT网关（新推出）.md)。

        本示例选择**小型**。

    -   **购买数量**：设置要购买NAT网关实例的数量。
    -   **计费周期**：选择NAT网关实例的计费周期。

创建成功后，您可以在**NAT网关**页面查看已创建的NAT网关实例。

![列表](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5656121061/p170825.png)

## 步骤二：将EIP与NAT网关绑定

NAT网关作为一个网关设备，需要绑定公网IP才能正常工作。创建NAT网关后，您可以为NAT网关绑定EIP。

完成以下操作，将EIP与NAT网关绑定。

1.  在**NAT网关**页面，找到步骤一创建的NAT网关实例，在其**操作**列下，选择**![更多操作](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2570920261/p103337.png)** \> **绑定弹性公网IP**。

2.  在绑定弹性公网IP对话框，根据以下信息为NAT网关绑定EIP。

    -   **所在资源组**：选择EIP所在的资源组。
    -   **选择弹性公网IP**：要绑定到NAT网关的EIP。

        本示例选择**从已有弹性公网IP中选择**，选择前提条件中已经创建的两个EIP。更多信息，请参见[前提条件](#section_0zt_20r_jau)。

3.  单击**确定**。


## 步骤三：创建DNAT条目

通过NAT网关的DNAT功能，可以将NAT网关上的公网IP映射给ECS实例使用，使ECS实例能够提供互联网服务。

完成以下操作，分别为ECS1和ECS2实例创建DNAT条目。

1.  在**NAT网关**页面，找到步骤一创建的NAT网关实例，单击其**操作**列下的**设置DNAT**。

2.  在**DNAT条目列表**区域，单击**创建DNAT条目**。

3.  在**创建DNAT条目**页面，根据以下信息为ECS1实例配置DNAT条目。

    -   **选择公网IP地址**：选择要提供互联网通信的公网IP。

        本示例选择EIP1。

    -   **选择私网IP地址**：选择要通过DNAT规则进行互联网通信的ECS实例。

        您可以通过以下两种方式指定目标ECS实例的私网IP：

        -   **通过ECS或弹性网卡进行选择**：从ECS实例或弹性网卡列表中选择ECS实例。
        -   **通过手动输入**：输入目标ECS实例的私网IP。

            **说明：** 手动输入的私网IP地址必须属于本VPC的CIDR范围，也可直接输入一个已有的ECS实例的私网IP。

        本示例选择交换机中已经创建的ECS1实例。

    -   **端口设置**：选择DNAT映射的方式。

        -   **任意端口**：该方式属于IP映射，任何访问该公网IP的请求都将转发到目标ECS实例上。
        -   **具体端口**：该方式属于端口映射，NAT网关会将以指定协议和端口访问该公网IP的请求转发到目标ECS实例的指定端口上。

            选择具体端口后，请根据业务需求设置以下参数：

            -   **公网端口**：进行端口转发的外部端口。
            -   **私网端口**：进行端口转发的内部端口。
            -   **协议类型**：转发端口的协议类型。
        本示例选择**具体端口**，然后设置**公网端口**为80、**私网端口**为80、**协议类型**为TCP。

    -   **条目名称**：DNAT条目的名称。

        名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。

        本示例输入DNAT1。

4.  单击**确定创建**。

5.  在**DNAT条目列表**区域，再次单击**创建DNAT条目**。

6.  在**创建DNAT条目**页面，根据以下信息为ECS2实例配置DNAT条目。

    -   **选择公网IP地址**：选择要提供互联网通信的公网IP。

        本示例选择EIP2。

    -   **选择私网IP地址**：选择要通过DNAT规则进行互联网通信的ECS实例。

        本示例选择交换机中已经创建的ECS2实例。

    -   **端口设置**：选择DNAT映射的方式。

        本示例选择**具体端口**，然后设置**公网端口**为80、**私网端口**为80、**协议类型**为TCP。

    -   **条目名称**：DNAT条目的名称。

        名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。

        本示例输入DNAT2。

7.  单击**确定创建**。


DNAT条目添加成功后，ECS1和ECS2实例的DNAT条目详情如下所示：

|条目名称|公网IP地址|公网端口|协议类型|私网IP地址|私网端口|
|----|------|----|----|------|----|
|DNAT1|EIP1|80|TCP|ECS1|80|
|DNAT2|EIP2|80|TCP|ECS2|80|

## 步骤四：创建共享带宽

共享带宽提供地域级带宽共享和复用功能，可以为您节省公网带宽使用成本。

完成以下操作，创建共享带宽。

1.  登录[共享带宽管理控制台](https://vpc.console.aliyun.com/cbwp/cn-hangzhou/cbwps)。

2.  在**共享带宽**页面，单击**购买共享带宽**。

3.  在购买页面，根据以下信息配置共享带宽实例，然后单击**立即购买**并完成支付。

    -   **商品类型**：选择共享带宽实例的商品类型。

        共享带宽实例支持包年包月和按量计费两种商品类型：

        -   **包年包月**：采用包年包月的计费方式。 更多信息，请参见[包年包月](/cn.zh-CN/产品定价/包年包月.md)。
        -   **按量计费**：采用按量计费的计费方式，流量支持按带宽和按增强95计费。 更多信息，请参见[按带宽计费](/cn.zh-CN/产品定价/按量计费/按带宽计费.md)和[按增强型95计费](/cn.zh-CN/产品定价/按量计费/按增强型95计费.md)。
        本示例选择**包年包月**。

    -   **地域**：选择共享带宽实例的地域。

        确保要加入共享带宽实例的EIP与共享带宽实例的地域相同。

    -   **线路类型**：选择共享带宽实例的线路类型。

        -   **BGP（多线）**：BGP（多线）线路共享带宽实例仅可以添加BGP（多线）线路EIP。
        -   **BGP（多线）\_精品**： BGP（多线）精品线路共享带宽实例仅可以添加BGP（多线）精品线路EIP。

            **说明：** 目前，仅中国（香港）地域支持BGP（多线）精品线路共享带宽实例。

        本示例选择**BGP（多线）**。

    -   **峰值带宽**：选择共享带宽实例的峰值带宽。

        本示例选择**1000 Mbps**。

    -   **资源组**：选择共享带宽所属的资源组。
    -   **名称**：输入共享带宽实例的名称。

        名称长度为2~128个字符，以大小字母或中文开头，可包含数字、下划线（\_）和短划线（-）。

    -   **数**：购买共享带宽实例的数量。

        本示例购买1个共享带宽实例。

    -   **计费周期**：选择共享带宽实例的计费周期，并选择是否自动续费。

## 步骤五：将EIP添加到共享带宽

您可以将EIP1和EIP2添加到共享带宽实例中，EIP添加到共享带宽实例后：

-   EIP绑定的NAT网关会共享已购买的共享带宽。
-   EIP原本的带宽峰值无效，与共享带宽实例的带宽峰值相同。
-   EIP原本的计费方式无效。EIP变为一个公网IP，不额外收取EIP的流量费和带宽费。

完成以下操作，分别将EIP1和EIP2添加到共享带宽实例中。

1.  在**共享带宽**页面，找到步骤四创建的共享带宽实例，单击其**操作**列下的**添加IP**。

2.  在**添加IP**面板，单击**从已有EIP列表选取**，然后选择资源组和要添加到共享带宽的EIP。

    本示例选择EIP1和EIP2添加到共享带宽实例中。

3.  单击**确定**。


## 步骤六：访问测试

您可以使用互联网中的任意一台电脑访问ECS1和ECS2实例上部署的应用服务，测试ECS实例的连通性。

**说明：** 请确保ECS实例的安全组规则允许互联网访问ECS实例。

1.  打开互联网任意电脑的浏览器。

2.  输入绑定到NAT网关的EIP访问部署在ECS实例上的应用服务。

    经验证，可以从互联网访问部署在ECS1和ECS2实例上的应用服务，同时ECS1和ECS2实例共用一份公网带宽，可以应对业务高峰。

    ![访问ECS1实例上的应用服务](../images/p170793.png "访问ECS1实例上的应用服务")

    ![访问ECS2实例上的应用服务](../images/p170794.png "访问ECS2实例上的应用服务")


