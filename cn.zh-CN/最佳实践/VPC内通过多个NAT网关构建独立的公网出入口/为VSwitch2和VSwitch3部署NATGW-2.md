---
keyword: [NAT网关, 增强型, 网络地址转换, 提供公网服务, 访问公网]
---

# 为VSwitch2和VSwitch3部署NATGW-2

本文介绍如何为默认安全域的VSwitch2和VSwitch3部署NAT网关，实现VSwitch上的实例访问公网服务和提供公网服务。

## 步骤一：创建NAT网关实例

在创建的VPC内创建一个按量计费的中型的NAT网关实例，用于绑定在VSwitch2和VSwitch3内。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在**NAT网关**页面，单击**创建NAT网关**。

3.  在**创建NAT网关**页面，配置以下购买信息，然后单击**立即购买**。

    -   **付费模式**：本文选择**按量付费**。
    -   **地域和可用区**：本文选择**华北5（呼和浩特）**。
    -   **可用区**：选择VSwitch2所属的可用区。
    -   **VPC ID**：选择创建的VPC。创建NAT网关后，不能修改NAT网关所属的VPC。
    -   **交换机ID**：选择创建的VSwitch2。
    -   **网关类型**：默认选择为**增强型**。
    -   **名称**：设置NAT网关实例的名称。

        名称长度为2~128个字符，以英文字母或中文开头，可包含数字、下划线（\_）和短划线（-）。

    -   **计费类型**：本文选择**按固定规格计费**，并且选择**规格**为**中型**。
    -   **计费周期**：默认显示NAT网关实例的计费周期为**按小时**。
4.  在支付订单页面确认支付金额，然后单击**支付**完成购买。

    当出现**恭喜，支付成功！**的提示后，说明您购买成功。


## 步骤二：添加自定义路由表用于Vswitch2和Vswitch3访问

路由表由路由条目组成，每个路由条目指定了网络流量的目的地。除默认路由表外，您还可以创建自定义路由表，管理子网路由流量。

1.  登录[专有网络管理控制台](https://vpcnext.console.aliyun.com/vpc)。

2.  在左侧导航栏，单击**路由表**。

3.  选择要创建的路由表的地域。

4.  在路由表页面，单击**创建路由表**。

5.  在创建路由表页面，根据以下信息配置路由表，然后单击**确定**。

    |配置|说明|
    |--|--|
    |**资源组**|选择路由表所属的资源组。|
    |**专有网络**|选择路由表所属的专有网络。|
    |**名称**|输入路由表的名称。 名称长度为2~128个字符，以英文字母或中文开头，可包含数字、下划线（\_）和短划线（-）。 |
    |**描述**|输入路由表的描述。 描述长度为2~256个字符，不能以`http://`和`https://`开头。 |

    创建路由表后，您可以在路由表页面查看**路由表类型**为**自定义**的路由表。系统会在自定义路由表中自动添加以下系统路由：

    -   以100.64.0.0/10为目标网段的路由条目，用于VPC内的云产品通信。
    -   以路由表所属VPC内的交换机网段为目标网段的路由条目，用于交换机内的云产品通信。
6.  在路由表页面，找到目标路由表，单击路由表ID。

7.  在路由表基本信息页面，单击**已绑定交换机**页签，然后单击**绑定交换机**。

8.  在绑定交换机页面，选择要绑定的VSwitch2和VSwitch3，然后单击**确定**。

9.  单击**路由条目列表**页签，然后单击**添加自定义路由条目**，在**添加路由条目**面板设置以下配置信息。

    |配置|说明|
    |:-|:-|
    |**名称**|输入路由条目的名称。 名称长度为2~128个字符之间，以英文字母或中文开头，可包含数字、下划线（\_）和短划线（-）。 |
    |**目标网段**|输入要转发到的目标网段，此处设置为0.0.0.0/32。|
    |**下一跳类型**|选择下一跳类型为**NAT网关**：将目的地址在目标网段范围内的流量路由至选择的NAT网关。|
    |**NAT网关**|选择下一跳实例为[步骤一：创建NAT网关实例](#section_kip_xd1_pvf)中创建的NAT网关。|

    添加完成后，新建的子网路由表中会增加一条默认路由指向增强型NAT网关。


## 步骤三：将多个EIP绑定到一个共享带宽来共享资源

1.  登录[共享带宽管理控制台](https://vpc.console.aliyun.com/cbwp/cn-hangzhou/cbwps)。

2.  在顶部菜单栏处，选择共享带宽实例的地域。

3.  在**共享带宽**页面，找到目标共享带宽实例，单击**操作**列下的**添加IP**。

4.  在**添加IP**对话框，选择**从已有EIP列表选取**，然后选择资源组和可用EIP，最后单击**确定**。


## 步骤四：将EIP逐个绑定到NAT网关

将创建的3个5 Mbps的EIP绑定到[步骤一：创建NAT网关实例](#section_kip_xd1_pvf)中创建的NAT网关实例中。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，单击**弹性公网IP**列下的**立即绑定**。

4.  在**绑定弹性公网IP**对话框，配置以下参数，然后单击**确定**。

    |配置|说明|
    |--|--|
    |**所在资源组**|选择EIP所在的资源组。|
    |**选择弹性公网IP**|选择**从已有弹性公网IP中选择**，然后在下拉列表中选择创建3个的5 Mbps的EIP实例。|

    绑定成功后，在NAT网关实例的**弹性公网IP**列将会显示出绑定的公网IP。


## 步骤五：创建DNAT条目

通过NAT网关的DNAT功能，可以将NAT网关上的公网IP映射给ECS实例使用，使ECS实例能够提供互联网服务。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，单击**操作**列下的**设置DNAT**。

4.  在**DNAT管理**页签，单击**创建DNAT条目**。

5.  在**创建DNAT条目**页面，配置DNAT条目参数，然后单击**确定创建**。

    1.  为VSwitch2设置以下DNAT规则。

        |配置|说明|
        |--|--|
        |**选择公网IP地址**|在下拉列表选择要提供互联网通信的EIP。|
        |**选择私网IP地址**|选择要通过DNAT规则进行互联网通信的ECS实例。选择**通过ECS或弹性网卡进行选择**：从ECS实例或弹性网卡列表中选择ECS实例。|
        |**端口设置**|选择DNAT映射的方式，选择**具体端口**。        -   **公网端口**：进行端口转发的外部端口，设置为8443。
        -   **私网端口**：进行端口转发的内部端口，设置为443。
        -   **协议类型**：转发端口的协议类型，选择TCP。 |
        |**条目名称**|DNAT条目的名称。名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。 |

    2.  为VSwitch3设置以下DNAT规则。

        |配置|说明|
        |--|--|
        |**选择公网IP地址**|在下拉列表选择要提供互联网通信的另一个EIP。|
        |**选择私网IP地址**|选择要通过DNAT规则进行互联网通信的ECS实例。选择**通过ECS或弹性网卡进行选择**：从ECS实例或弹性网卡列表中选择ECS实例。|
        |**端口设置**|选择DNAT映射的方式，选择**具体端口**。        -   **公网端口**：进行端口转发的外部端口，设置为8800。
        -   **私网端口**：进行端口转发的内部端口，设置为80。
        -   **协议类型**：转发端口的协议类型，选择TCP。 |
        |**条目名称**|DNAT条目的名称。名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。 |


## 步骤六：创建SNAT条目

NAT网关的SNAT功能可以为VPC中无公网IP的ECS实例提供访问互联网的代理服务。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，单击**操作**列下的**设置SNAT**。

4.  在**SNAT管理**页签，单击**创建SNAT条目**。

5.  在**创建SNAT条目**页面，配置以下参数，然后单击**确定创建**。

    将VSwitch2和VSwitch3都指向同一个SNAT中绑定的EIP。

    |配置|说明|
    |:-|:-|
    |**SNAT条目粒度**|选择SNAT条目的粒度。本文以选择**交换机粒度**为例：指定交换机下的ECS实例通过配置的公网IP访问互联网。    -   **选择交换机**：在下拉列表中选择交换机。如果下拉列表中没有可选的交换机，可在下拉列表单击**创建交换机**跳转到VPC控制台创建交换机。

**说明：** 如您选择多个交换机，将会为您创建多条SNAT条目，使用相同的公网IP地址。

    -   **交换机网段**：显示交换机的网段。 |
    |**选择公网IP地址**|选择用来提供互联网访问的公网IP。本文以选择**使用单IP**为例，在下拉列表中选择弹性公网IP。如果下拉列表中没有可选的弹性公网IP，可在下拉列表单击**新购弹性公网IP并绑定**购买弹性公网IP。|
    |**条目名称**|输入SNAT条目的名称。 名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。 |


[测试验证和指标监控](/cn.zh-CN/最佳实践/VPC内通过多个NAT网关构建独立的公网出入口/测试验证和指标监控.md)

