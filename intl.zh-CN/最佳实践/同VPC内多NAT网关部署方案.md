---
keyword: [NAT网关, 增强型, 网络地址转换, 提供公网服务, 访问公网]
---

# 同VPC内多NAT网关部署方案

同一个VPC内支持创建多个增强型NAT网关，您可以通过不同的NAT网关来转发去往不同目的地址的流量，并可以针对不同的NAT网关做不同的安全防护，实现更精细化的部署公网访问网络。

## 同VPC内部署多NAT网关的场景说明

本部署方案将根据以下目标场景，利用增强型NAT产品在同一个VPC内构建独立的公网出入口的网络环境。

![同VPC多NAT网关方案架构图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1805619061/p206992.png)

上述场景方案中的交换机对应的场景说明如下：

-   VSwitch1：属于默认安全域，关联系统路由表。

    独立公网IP，50 Mbps带宽；不主动对外暴露公网IP，只允许内部主机主动对外访问，并要求独立环境。

-   VSwitch2：属于特殊安全域，关联VPC子网路由表。

    共享特殊安全域内的统一公网出口1 Gbps；既能被外网访问，同时需要主动访问公网。

-   VSwitch3：属于特殊安全域，关联VPC子网路由表。

    共享特殊安全域内的统一公网出口1 Gbps；既能被外网访问，同时需要主动访问公网。


## 同VPC内部署多NAT网关的解决方案说明

针对上述场景，您需要创建的资源和对应的解决方案罗列如下：

-   创建一个VPC来部署3个VSwitch，其中默认安全域内部署一套NAT网关（NATGW-1），VSwitch1使用该套网关；独立安全域内部署另一套NAT网关（NATGW-2），VSwitch2和VSwitch3共享这套网关。
-   创建一个50 Mbps的EIP，用于绑定NATGW-1的SNAT。
-   申请一个1 Gbps的共享带宽，用于NATGW-2，再申请3个EIP加入到该共享带宽中，2个EIP分别用于VSwitch2和VSwitch3的DNAT使用，第三个EIP用于两个VSwitch的SNAT访问。
-   配置NAT网关的监控，针对NATGW-2下不同VSwitch的SNAT流量进行监控，监控VSwitch的使用情况。

## 同VPC内部署多NAT网关的配置汇总

|云资源|配置|数量|
|---|--|--|
|VPC|呼和浩特地域|1个|
|VSwitch|分布于两个可用区|3 个|

|云资源|配置|数量|
|---|--|--|
|增强型NAT实例|按使用量计费|1个|
|EIP|按量付费-50 Mbps|1个|
|ECS|ecs.g6e.large|1 台|

|云资源|配置|数量|
|---|--|--|
|增强型NAT实例|按使用量计费|1个|
|EIP|按量付费-5 Mbps|3个|
|共享带宽|按量付费-1 Gbps|1个|
|ECS|ecs.g6e.large|2台|

## 部署流程

![同VPC内多NAT网关部署流程](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0805619061/p206994.png)

## 步骤一：准备云网络资源

在为交换机部署NAT网关前，您需先创建VPC、VSwitch、ECS、EIP和共享带宽等云资源。

|云网络资源|规格描述|数量|具体操作|
|-----|----|--|----|
|VPC|**地域**：华北5（呼和浩特）。|1个|[创建专有网络和交换机](/intl.zh-CN/快速入门/搭建IPv4专有网络.md)|
|VSwitch|**可用区**：-   呼和浩特可用区A：1个，VSwitch1部署在该可用区。
-   呼和浩特可用区B：2个，VSwitch2和VSwitch3部署在该可用区。

|3个|[创建专有网络和交换机](/intl.zh-CN/快速入门/搭建IPv4专有网络.md)|
|ECS实例|-   **付费模式**：选择**按量付费**。
-   **地域及可用区**：华北5（呼和浩特）。
-   **实例**：本操作选择ecs.g6e.large。
-   **网络**：已创建的专有网络和交换机。
    -   呼和浩特可用区A：1个。
    -   呼和浩特可用区B：2个。
-   **公网IP**： 选择不分配。
-   **安全组**：选择使用默认安全组。

|3台|[创建ECS实例](/intl.zh-CN/快速入门/搭建IPv4专有网络.md)|
|EIP|-   **地域**：华北5（呼和浩特）。
-   **带宽峰值**：1个50 Mbps，3个5 Mbps。

|4个|[申请新EIP](/intl.zh-CN/用户指南/申请EIP/申请新EIP.md)|
|共享带宽|-   **地域**：华北5（呼和浩特）。
-   **峰值带宽**：1000 Mbps。

|1个|[创建共享带宽实例](/intl.zh-CN/用户指南/创建共享带宽实例.md)|

## 步骤二：创建两个NAT网关实例

在创建的VPC内创建两个按使用量计费的NAT网关实例，名称为NATGW-1和NATGW-2，其中NATGW-1用于绑定在VSwitch1内，NATGW-2用于绑定在VSwitch2和VSwitch3内。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在**NAT网关**页面，单击**创建NAT网关**。

3.  首次使用NAT网关时，需在**创建NAT网关**页面最下方的关联角色创建须知区域，单击**创建**，创建服务关联角色。角色创建成功后即可创建NAT网关。

    ![创建角色](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9503170161/p225001.png)

4.  在**创建NAT网关**面板，配置以下购买信息，然后单击**立即购买**。

    -   创建NATGW-1时，购买信息如下：
        -   **地域和可用区**：本文选择**华北5（呼和浩特）**。
        -   **可用区**：选择VSwitch1所属的可用区，呼和浩特可用区A。
        -   **VPC ID**：选择创建的VPC。创建NAT网关后，不能修改NAT网关所属的VPC。
        -   **交换机ID**：选择创建的VSwitch1。
        -   **网关类型**：默认选择为**增强型**。
        -   **计费类型**：本文选择**按使用量计费**。
        -   **计费类型**：选择NAT网关实例的计费类型。

            目前，仅支持按固定规格计费。

        -   **计费周期**：默认显示NAT网关实例的计费周期为**按小时**。
    -   创建NATGW-2时，购买信息如下：
        -   **地域和可用区**：本文选择**华北5（呼和浩特）**。
        -   **可用区**：选择VSwitch2所属的可用区，呼和浩特可用区B。
        -   **VPC ID**：选择创建的VPC。创建NAT网关后，不能修改NAT网关所属的VPC。
        -   **交换机ID**：选择创建的VSwitch2。
        -   **网关类型**：默认选择为**增强型**。
        -   **计费类型**：本文选择**按使用量计费**。
        -   **计费类型**：选择NAT网关实例的计费类型。

            目前，仅支持按固定规格计费。

        -   **计费周期**：默认显示NAT网关实例的计费周期为**按小时**。
5.  在支付订单页面确认支付金额，然后单击**支付**完成购买。

    当出现**恭喜，支付成功！**的提示后，说明您购买成功。


## 步骤三：添加自定义路由表用于VSwitch2和VSwitch3访问

路由表由路由条目组成，每个路由条目指定了网络流量的目的地。除默认路由表外，您还可以创建自定义路由表，管理路由流量。

1.  登录[专有网络管理控制台](https://vpcnext.console.aliyun.com/vpc)。

2.  在左侧导航栏，单击**路由表**。

3.  选择要创建的路由表的地域。

    自定义路由表功能支持的地域信息，请参见[自定义路由表发布及地域支持情况]()。

4.  在路由表页面，单击**创建路由表**。

5.  在创建路由表页面，根据以下信息配置路由表，然后单击**确定**。

    |配置|说明|
    |--|--|
    |**资源组**|选择路由表所属的资源组。|
    |**专有网络**|选择路由表所属的专有网络。|
    |**名称**|输入路由表的名称。 名称长度为2~128个字符，以英文字母或中文开头，可包含数字、下划线（\_）和短划线（-）。 |
    |**描述**|输入路由表的描述。 描述长度为2~256个字符，不能以`http://`和`https://`开头。 |

    创建路由表后，您可以在路由表页面查看**路由表类型**为**自定义**的路由表。系统会在自定义路由表中自动添加以下系统路由：

    -   以100.64.0.0/10为目标网段的路由条目，用于VPC内的云产品通信。
    -   以路由表所属VPC内的交换机网段为目标网段的路由条目，用于交换机内的云产品通信。
6.  在路由表页面，找到目标路由表，单击路由表ID。

7.  在路由表基本信息页面，单击**已绑定交换机**页签，然后单击**绑定交换机**。

8.  在绑定交换机页面，选择要绑定的VSwitch2和VSwitch3，然后单击**确定**。

9.  单击**路由条目列表**页签，然后单击**添加自定义路由条目**，在**添加路由条目**面板设置以下配置信息。

    |配置|说明|
    |:-|:-|
    |**名称**|输入路由条目的名称。 名称长度为2~128个字符之间，以英文字母或中文开头，可包含数字、下划线（\_）和短划线（-）。 |
    |**目标网段**|输入要转发到的目标网段，此处设置为0.0.0.0/32。|
    |**下一跳类型**|选择下一跳类型为**NAT网关**：将目的地址在目标网段范围内的流量路由至选择的NAT网关。|
    |**NAT网关**|选择下一跳实例为[步骤二：创建两个NAT网关实例](#section_k9k_fg8_9mf)中创建的NATGW-2网关。|

    添加完成后，新建的路由表中会增加一条默认路由指向增强型NAT网关。


## 步骤四：将3个5 Mbps带宽的EIP绑定到一个共享带宽来共享资源

1.  登录[共享带宽管理控制台](https://vpc.console.aliyun.com/cbwp/cn-hangzhou/cbwps)。

2.  在顶部菜单栏处，选择共享带宽实例的地域。

3.  在**共享带宽**页面，找到目标共享带宽实例，单击**操作**列下的**添加IP**。

4.  在**添加IP**对话框，选择**从已有EIP列表选取**，然后选择可用EIP，最后单击**确定**。


## 步骤五：将4个EIP逐个绑定到NAT网关

将创建的EIP绑定到[步骤二：创建两个NAT网关实例](#section_k9k_fg8_9mf)中创建的NAT网关实例中，其中50 Mbps的EIP绑定到NATGW-1，3个5 Mbps的EIP绑定到NATGW-2。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，单击**弹性公网IP**列下的**立即绑定**。

4.  在**绑定弹性公网IP**对话框，配置以下参数，然后单击**确定**。

    |配置|说明|
    |--|--|
    |**所在资源组**|选择EIP所在的资源组。|
    |**选择弹性公网IP**|选择**从已有弹性公网IP中选择**，然后在下拉列表中选择EIP：    -   当绑定EIP到NATGW-1时，选择创建的50 Mbps的EIP实例。
    -   当绑定EIP到NATGW-2时，选择创建的3个5 Mbps的EIP实例 |

    绑定成功后，在NAT网关实例的**弹性公网IP**列将会显示出绑定的公网IP。


## 步骤六：创建SNAT条目

NAT网关的SNAT功能可以为VPC中无公网IP的ECS实例提供访问互联网的代理服务。为NATGW-1和NATGW-2网关创建3条SNAT条目。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，单击**操作**列下的**设置SNAT**。

4.  在**SNAT管理**页签，单击**创建SNAT条目**。

5.  在**创建SNAT条目**页面，配置以下参数，然后单击**确定创建**。

    -   当为NATGW-1创建SNAT条目时，选择VSwitch1。
    -   当为NATGW-2创建SNAT条目时，请将VSwitch2和VSwitch3都指向同一个SNAT中绑定的EIP。
    |配置|说明|
    |:-|:-|
    |**SNAT条目粒度**|选择SNAT条目的粒度。本文以选择**交换机粒度**为例：指定交换机下的ECS实例通过配置的公网IP访问互联网。    -   **选择交换机**：在下拉列表中选择交换机。如果下拉列表中没有可选的交换机，可在下拉列表单击**创建交换机**跳转到VPC控制台创建交换机。

**说明：** 如您选择多个交换机，将会为您创建多条SNAT条目，使用相同的公网IP地址。

    -   **交换机网段**：显示交换机的网段。 |
    |**选择公网IP地址**|选择用来提供互联网访问的公网IP。本文以选择**使用单IP**为例，在下拉列表中选择弹性公网IP。如果下拉列表中没有可选的弹性公网IP，可在下拉列表单击**新购弹性公网IP并绑定**购买弹性公网IP。|
    |**条目名称**|输入SNAT条目的名称。 名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。 |


## 步骤七：创建DNAT条目

通过NAT网关的DNAT功能，可以将NAT网关上的公网IP映射给ECS实例使用，使ECS实例能够提供互联网服务。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，单击**操作**列下的**设置DNAT**。

4.  在**DNAT管理**页签，单击**创建DNAT条目**。

5.  在**创建DNAT条目**页面，配置DNAT条目参数，然后单击**确定创建**。

    为VSwitch2和VSwitch3设置以下DNAT规则。

    |配置|说明|
    |--|--|
    |**选择公网IP地址**|在下拉列表选择要提供互联网通信的EIP。|
    |**选择私网IP地址**|选择要通过DNAT规则进行互联网通信的ECS实例。选择**通过ECS或弹性网卡进行选择**：从ECS实例或弹性网卡列表中选择ECS实例。|
    |**端口设置**|选择DNAT映射的方式，选择**具体端口**。VSwitch2和VSwitch3的设置如下：

    -   VSwitch2：
        -   **公网端口**：进行端口转发的外部端口，设置为8443。
        -   **私网端口**：进行端口转发的内部端口，设置为443。
        -   **协议类型**：转发端口的协议类型，选择TCP。
    -   VSwitch3：
        -   **公网端口**：进行端口转发的外部端口，设置为8800。
        -   **私网端口**：进行端口转发的内部端口，设置为80。
        -   **协议类型**：转发端口的协议类型，选择TCP。 |
    |**条目名称**|DNAT条目的名称。名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。 |


## 测试验证和指标监控



登录ECS实例，以VSwitch1下的ECS实例为例，执行以下操作步骤，验证各ECS访问公网的能力，并可查看该ECS实例上绑定的SNAT地址。

1.  登录VSwitch1下的ECS实例。

2.  通过`ping`命令测试网络连通性。

    经测试，ECS实例可以访问互联网。

    ![测试SNAT](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9601969061/p208573.png)

3.  使用`curl myip.ipip.net`命令探测ECS上绑定的SNAT地址。

    ![查看SNAT地址](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9601969061/p208574.png)




为了便于直观展示DNAT访问效果，在控制台加入了两台ECS的port-22映射，用于SSH登录。

1.  使用外网机器访问VSwitch2和VSwitch3的DNAT入口。

    ![访问DNAT的ECS](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9601969061/p208575.png)

2.  登录ECS实例执行`ifconfig`查看到IP信息与ECS的私网IP一致，证明该ECS有提供公网服务。

    ![访问记录](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9601969061/p208576.png)




1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关，单击**监控**列下的![](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1713019951/p41324.png)图标查看监控。

    |监控指标分类|监控项|说明|
    |------|---|--|
    |Snat Session统计|并发连接数|NAT网关可同时容纳的TCP/UDP连接数量。|
    |并发丢弃连接速率|NAT网关连接数超过并发连接数限制，而导致无法新建被丢弃的连接速率。|
    |新建连接速率/新建丢弃连接速率|新建连接速率：NAT网关每秒可新建的TCP/UDP连接速率。新建丢弃连接速率：NAT网关每秒新建连接数超过每秒最大新建连接限制，而导致无法新建被丢弃的连接速率。 |
    |并发连接水位/新建连接水位|并发连接水位：已消耗连接数占总连接数的百分比。新建连接水位：已消耗的新建连接数占总新建连接数的百分比。 |
    |入方向统计|入方向流量速率|入方向每秒接受的流量，包括：    -   从公网来流量速率。
    -   入VPC流量速率。 |
    |入方向流量|入方向所消耗的流量，包括：    -   从公网来流量。
    -   入VPC流量。 |
    |入方向包速率|入方向每秒接受的数据包数量，包括：    -   从公网来包速率。
    -   入VPC包速率。 |
    |入方向包量|入方向所消耗的数据包数量，包括：    -   从公网来包量。
    -   入VPC包量。 |
    |出方向统计|出方向流量速率|出方向每秒接受的流量，包括：    -   入公网流量速率。
    -   从VPC来流量速率。 |
    |出方向流量|出方向所消耗的流量，包括：    -   入公网流量。
    -   从VPC来流量。 |
    |出方向包速率|出方向每秒接受的数据包数量，包括：    -   入公网包速率。
    -   从VPC来包速率。 |
    |出方向包量|出方向所消耗的数据包数量，包括：    -   入公网包量。
    -   从VPC来包量。 |


