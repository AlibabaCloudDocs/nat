# 创建SNAT IP地址池

您可以在创建SNAT条目时，将多个EIP加入到一个SNAT地址池。VPC ECS实例可以随机通过SNAT地址池中的EIP访问互联网。

## 前提条件

-   您已创建专有网络和交换机。具体操作，请参见[创建专有网络和交换机](/intl.zh-CN/快速入门/搭建IPv4专有网络.md)。
-   您已申请待加入到SNAT地址池的EIP。具体操作，请参见[申请新EIP](/intl.zh-CN/用户指南/申请EIP/申请新EIP.md)。

## 背景信息

NAT网关是一款企业级的VPC公网网关，提供SNAT功能，为VPC内无公网IP的ECS实例提供访问互联网的代理服务。如果您在创建SNAT条目时，只为指定的交换机或ECS实例配置1个EIP。当ECS实例负载激增时，1个EIP无法支撑巨大的访问量。

您可以选择添加多个EIP到一个SNAT地址池中，当VPC ECS实例主动发起对外的访问连接时，VPC ECS实例会随机通过SNAT地址池中的EIP访问互联网。

![SNAT IP地址池](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4659188161/p47136.png)

## 步骤一：创建NAT网关

完成以下操作，创建NAT网关。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。
2.  在NAT网关页面，单击**创建NAT网关**。
3.  在**创建NAT网关**面板，根据以下信息，配置NAT网关并完成支付。
    -   **地域和可用区**：选择需要创建NAT网关的地域。
    -   **可用区**：选择NAT网关实例所属的可用区。
    -   **VPC ID**：选择NAT网关所属的VPC。创建NAT网关后，不能修改NAT网关所属的VPC。

        **说明：** 如果在VPC列表中，找不到目标VPC，请排查是否有以下情况：

        -   在选择地域内没有VPC。
        -   查看该VPC中是否存在目标网段为0.0.0.0/0的自定义路由。如果存在，请删除该路由条目。
        -   RAM账号不具备读取访问VPC的权限，请联系主账号进行授权。
    -   **交换机ID**：选择NAT网关实例所属的交换机。
    -   **网关类型**：默认选择为**增强型**。

        增强型NAT网关兼容普通型NAT网关的全部功能，并在普通型NAT网关的技术架构上作了升级，具有更优的弹性和更强的稳定性，帮助您更好的管理公网访问流量。

    -   **计费类型**：选择NAT网关实例的计费类型。

        目前，仅支持按使用量计费。更多信息，请参见[按使用量计费](/intl.zh-CN/购买指南/按量付费.md)。

    -   **计费周期**：显示NAT网关实例的计费周期。

## 步骤二：将EIP绑定到NAT网关

完成以下操作，将EIP绑定到NAT网关。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。
2.  在顶部菜单栏处，选择NAT网关的地域。
3.  在**NAT网关**页面，找到目标NAT网关实例，单击**弹性公网IP**列下的**立即绑定**。
4.  在绑定弹性公网IP对话框，配置以下参数，然后单击**确定**。
    -   **所在资源组**：选择EIP所在的资源组。
    -   **选择弹性公网IP**：本文以选择**新购弹性公网IP并绑定**为例进行说明。系统会为您创建1个按使用流量计费的按量付费EIP，并绑定到NAT网关。
5.  重复以上步骤绑定更多EIP。

## 步骤三：将EIP加入共享带宽

完成以下操作，将EIP加入共享带宽。

1.  登录[弹性公网IP管理控制台](https://vpc.console.aliyun.com/eip)。
2.  在顶部菜单栏处，选择EIP的地域。
3.  在弹性公网IP页面，找到目标EIP，选择**操作**列下的**![更多操作](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8408559951/p143776.png)** \> **加入共享带宽**。
4.  选择要加入的共享带宽，然后单击**确定**。

## 步骤四：创建SNAT条目

完成以下操作，创建SNAT条目，将多个EIP加入到一个SNAT地址池。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。
2.  在顶部菜单栏处，选择NAT网关的地域。
3.  在NAT网关页面，找到目标NAT网关实例，单击**操作**列下的**设置SNAT**。
4.  在SNAT管理页签，单击**创建SNAT条目**。
5.  在创建SNAT条目页面，根据以下信息配置SNAT条目，然后单击**确定创建**。

    **交换机粒度**：

    -   **选择交换机**：选择VPC中的交换机。该交换机下所有ECS实例都将通过SNAT功能进行公网访问。
    -   **交换机网段**：显示该交换机的网段。
    -   **选择公网IP地址**：选择用来提供互联网访问的公网IP。
        -   **使用单IP**：在下拉列表中选择弹性公网IP。如果下拉列表中没有可选的弹性公网IP，可在下拉列表单击**新购弹性公网IP并绑定**，在弹出的对话框中完成弹性公网IP的购买操作。
        -   **使用多IP**：多个IP地址配置至SNAT IP地址池时，请确保所选IP地址在一个共享带宽中。当VPC ECS实例主动发起对外的访问连接时，VPC ECS实例会随机通过SNAT地址池中的公网IP地址访问互联网。
            -   **共享带宽**：在下拉列表选择共享带宽。如果下拉列表中没有可选的共享带宽，可在下拉列表单击**创建共享带宽**，在共享带宽购买页完成购买。
            -   **公网IP**：在下拉列表选择已经被加入到选定共享带宽中的弹性公网IP。
    -   **条目名称**：输入SNAT条目的名称。
    **ECS粒度**：

    -   **选择ECS**：选择VPC中的ECS实例。
    -   **ECS网段**：显示该ECS实例的网段。
    -   **选择公网IP地址**：选择用来提供互联网访问的公网IP。
        -   **使用单IP**：在下拉列表中选择弹性公网IP。如果下拉列表中没有可选的弹性公网IP，可在下拉列表单击**新购弹性公网IP并绑定**，在弹出的对话框中完成弹性公网IP的购买操作。
        -   **使用多IP**：多个IP地址配置至SNAT IP地址池时，请确保所选IP地址在一个共享带宽中。当VPC ECS实例主动发起对外的访问连接时，VPC ECS实例会随机通过SNAT地址池中的公网IP地址访问互联网。
            -   **共享带宽**：在下拉列表选择共享带宽。如果下拉列表中没有可选的共享带宽，可在下拉列表单击**创建共享带宽**，在共享带宽购买页完成购买。
            -   **公网IP**：在下拉列表选择已经被加入到选定共享带宽中的弹性公网IP。
    -   **条目名称**：输入SNAT条目的名称。

## 步骤五：测试访问

分别登录两台设置了SNAT规则的ECS实例，查看出网的源IP地址。

![ECS1查看出网的源IP地址](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8634029951/p47157.png)

![ECS2查看出网的源IP地址](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8634029951/p47158.png)

