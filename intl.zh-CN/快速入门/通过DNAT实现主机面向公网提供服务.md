# 通过DNAT实现主机面向公网提供服务

本教程指导您配置NAT网关的DNAT功能，实现ECS实例面向公网提供服务。

## 配置场景

本教程以下图场景为例。某公司在阿里云创建了ECS实例，并在ECS实例上部署了应用服务，但未给ECS实例分配固定公网IP，也未绑定弹性公网IP（Elastic IP Address，简称EIP）。因公司业务发展，需要互联网可以访问ECS实例中部署的应用服务。

您可以通过DNAT功能，将NAT网关上的公网IP映射给ECS实例使用，使ECS实例可以面向互联网提供服务。

![配置场景](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2371359951/p158127.png)

## 前提条件

开始前，请确保满足以下条件：

-   您已经注册了阿里云账号。如未注册，请先完成[账号注册](https://account.alibabacloud.com/register/intl_register.htm)。
-   您已经创建了专有网络VPC（Virtual Private Cloud）和交换机。具体操作，请参见[使用专有网络](/intl.zh-CN/专有网络和交换机/使用专有网络.md)和[使用交换机](/intl.zh-CN/专有网络和交换机/使用交换机.md)。
-   您已经在交换机中创建了ECS实例，且ECS实例部署了应用服务。具体操作，请参见[使用向导创建实例](/intl.zh-CN/实例/创建实例/使用向导创建实例.md)。

## 配置步骤

![配置步骤](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2371359951/p158124.png)

## 步骤一：创建NAT网关

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在**NAT网关**页面，单击**创建NAT网关**。

3.  如果首次购买增强型NAT网关，您需要在**创建NAT网关**面板最下方的关联角色创建须知区域，单击**创建**，完成NAT网关的服务关联角色创建。角色创建成功后即可购买NAT网关。

    ![创建角色](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9503170161/p225001.png)

4.  在**创建NAT网关**面板，配置以下购买信息，然后单击**立即购买**。

    -   **地域和可用区**：选择需要创建NAT网关的地域。
    -   **可用区**：选择NAT网关实例所属的可用区。
    -   **VPC ID**：选择NAT网关所属的VPC。创建NAT网关后，不能修改NAT网关所属的VPC。
    -   **交换机ID**：选择NAT网关实例所属的交换机。
    -   **网关类型**：默认选择为**增强型**。
    -   **计费类型**：选择NAT网关实例的计费类型。

        目前，仅支持按使用量计费。更多信息，请参见[按使用量计费](/intl.zh-CN/购买指南/按量付费.md)。

    -   **计费周期**：默认选择为**按小时**，即按使用量计费NAT网关的计费周期为1小时，不足1小时按1小时计算。
5.  在**确认订单**页面确认NAT网关的配置信息，选中服务协议并单击**立即开通**。

    当出现**恭喜，开通成功！**的提示后，说明您创建成功。


创建成功后，您可以在**NAT网关**页面查看已创建的NAT网关实例。

![创建NAT网关](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2007960161/p224758.png)

## 步骤二：绑定EIP

NAT网关作为一个网关设备，需要绑定EIP才能正常工作。创建NAT网关后，您可以为NAT网关绑定EIP。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，然后在**弹性公网IP**列单击**立即绑定**。

4.  在绑定弹性公网IP对话框，配置以下参数，然后单击**确定**。

    |配置|说明|
    |--|--|
    |**所在资源组**|选择EIP所在的资源组。|
    |**选择弹性公网IP**|要绑定到NAT网关的EIP。本文以选择**新购弹性公网IP并绑定**为例进行说明。系统会为您创建1个按使用流量计费的按量付费EIP，并绑定到NAT网关。 |

    绑定成功后，在NAT网关实例的**弹性公网IP**列将会显示出绑定的EIP。


## 步骤三：创建DNAT条目

通过NAT网关的DNAT功能，可以将NAT网关上的公网IP映射给ECS实例使用，使ECS实例能够提供互联网服务。

1.  登录[NAT网关管理控制台](https://vpc.console.aliyun.com/nat)。

2.  在顶部菜单栏处，选择NAT网关的地域。

3.  在**NAT网关**页面，找到目标NAT网关实例，然后在**操作**列下单击**设置DNAT**。

4.  在**DNAT管理**页签，单击**创建DNAT条目**。

5.  在**创建DNAT条目**页面，配置DNAT条目参数，然后单击**确定创建**。

    |配置|说明|
    |--|--|
    |**选择公网IP地址**|在下拉列表选择要提供互联网通信的公网IP。 **说明：**

    -   普通型NAT网关不支持将一个公网IP同时用于DNAT条目和SNAT条目。
    -   增强型NAT网关支持将一个公网IP同时用于DNAT条目和SNAT条目。 |
    |**选择私网IP地址**|选择要通过DNAT规则进行互联网通信的ECS实例。您可以通过以下两种方式指定目标ECS实例的私网IP：    -   **通过ECS或弹性网卡进行选择**：从ECS实例或弹性网卡列表中选择ECS实例。
    -   **通过手动输入**：输入目标ECS实例的私网IP。 |
    |**端口设置**|选择DNAT映射的方式。    -   **任意端口**：该方式属于IP映射，任何访问该公网IP的请求都将转发到目标ECS实例上，目标ECS实例也可以使用该公网IP主动访问公网。

**说明：**

        -   DNAT条目中配置了IP映射方式的EIP不能再被其他DNAT条目或SNAT条目使用。
        -   如果NAT网关既配置了DNAT IP映射方式，又配置了SNAT条目，则ECS实例会优先通过DNAT IP映射方式的公网IP访问公网。
    -   **具体端口**：该方式属于端口映射，NAT网关会将以指定协议和端口访问该公网IP的请求转发到目标ECS实例的指定端口上。

选择具体端口后，请根据业务需求设置以下参数：

        -   **公网端口**：进行端口转发的外部端口。

当选择的公网IP已创建了SNAT条目，且需要设置的公网端口号大于1024，请单击**开启端口突破**并在弹出的对话框单击**确定**。该操作会导致部分存量SNAT的连接闪断，重连即可恢复，请您谨慎操作。

        -   **私网端口**：进行端口转发的内部端口。
        -   **协议类型**：转发端口的协议类型。 |
    |**条目名称**|DNAT条目的名称。名称长度为2~128个字符，以大小写字母或中文开头， 可包含数字、下划线（\_）和短划线（-）。 |


## 步骤四：测试连通性

DNAT条目配置成功后，您可以使用互联网中的任意一台电脑访问ECS实例上部署的服务，测试ECS实例的连通性。

**说明：** 请确保ECS实例的安全组规则允许互联网访问ECS实例，更多信息，请参见[安全组概述](/intl.zh-CN/安全/安全组/安全组概述.md)。

1.  打开电脑的浏览器。

2.  输入绑定到NAT网关的EIP的IP地址访问部署在ECS实例上的应用服务。

    经验证，互联网可以访问部署在ECS实例上的应用服务。

    ![测试结果1](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3371359951/p143481.png)


